const http = require('http');
const WebSocket = require('ws');
const crypto = require('crypto'); // C·∫ßn cho thu·∫≠t to√°n hash

// Port server HTTP
const PORT = process.env.PORT || 10000;

// D·ªØ li·ªáu hi·ªán t·∫°i ƒë·ªÉ tr·∫£ v·ªÅ API (kh√¥ng c√≥ chi ti·∫øt x√∫c x·∫Øc)
let currentData = {
    phien_truoc: null,
    ket_qua: "",
    phien_hien_tai: null,
    du_doan: "Ch·ªù",
    do_tin_cay: "0%",
    cau: "",
    ngay: "",
    Id: "@ghetvietcode - Rinkivana",
    chi_tiet_du_doan: {} // Th√™m chi ti·∫øt cho debug
};

// L·ªãch s·ª≠ d·ªØ li·ªáu cho c√°c thu·∫≠t to√°n
let patternHistory = "";   // Chu·ªói c·∫ßu T/X ƒë·ªÉ hi·ªÉn th·ªã
let totalsHistory = [];    // L·ªãch s·ª≠ t·ªïng ƒëi·ªÉm c√°c phi√™n (totals_list)
let kqHistory = [];        // L·ªãch s·ª≠ k·∫øt qu·∫£ T√†i/X·ªâu (kq_list)
let diceHistory = [];      // L·ªãch s·ª≠ x√∫c x·∫Øc t·ª´ng phi√™n (dice_list)


// =======================================================================
// ===== B·ªò THU·∫¨T TO√ÅN D·ª∞ ƒêO√ÅN M·ªöI (ƒê√É D·ªäCH SANG JAVASCRIPT) =====
// =======================================================================

// H√†m ph·ª• tr·ª£: Chuy·ªÉn t·ªïng ƒëi·ªÉm sang T√†i/X·ªâu
function getTaiXiu(total) {
    return (total >= 11 && total <= 18) ? "T√†i" : "X·ªâu";
}

// ===== THU·∫¨T TO√ÅN 1: Ph√¢n t√≠ch c·∫ßu ƒë·∫∑c bi·ªát =====
function du_doan_v1(totals_list) {
    if (totals_list.length < 4) {
        return ["Ch·ªù", "ƒê·ª£i th√™m d·ªØ li·ªáu ƒë·ªÉ ph√¢n t√≠ch c·∫ßu."];
    }

    const last_4 = totals_list.slice(-4);
    const last_3 = totals_list.slice(-3);
    const last_total = totals_list.at(-1);
    const last_result = getTaiXiu(last_total);

    // C·∫ßu ƒë·∫∑c bi·ªát A-B-A-A
    if (last_4[0] === last_4[2] && last_4[0] === last_4[3] && last_4[0] !== last_4[1]) {
        return ["T√†i", `C·∫ßu ƒë·∫∑c bi·ªát ${last_4.join('-')}. B·∫Øt T√†i theo c√¥ng th·ª©c.`];
    }
    // C·∫ßu sandwich A-B-A
    if (last_3[0] === last_3[2] && last_3[0] !== last_3[1]) {
        return [last_result === "T√†i" ? "X·ªâu" : "T√†i", `C·∫ßu sandwich ${last_3.join('-')}. B·∫ª c·∫ßu!`];
    }
    // M·∫∑c ƒë·ªãnh b·∫ª c·∫ßu 1-1
    return [last_result === "T√†i" ? "X·ªâu" : "T√†i", "Kh√¥ng c√≥ c·∫ßu ƒë·∫∑c bi·ªát, d·ª± ƒëo√°n theo c·∫ßu 1-1."];
}

// ===== THU·∫¨T TO√ÅN 2: Ph√¢n t√≠ch v·ªõi ƒë·ªô tin c·∫≠y =====
function du_doan_v2(totals_list) {
    if (totals_list.length < 4) {
        return ["Ch·ªù", 0, "Ch∆∞a ƒë·ªß d·ªØ li·ªáu ƒë·ªÉ d·ª± ƒëo√°n."];
    }
    const last_4 = totals_list.slice(-4);
    const last_3 = totals_list.slice(-3);
    const last_6 = totals_list.slice(-6);
    const last_total = totals_list.at(-1);
    const last_result = getTaiXiu(last_total);
    
    // C·∫ßu sandwich A-B-A
    if (last_3[0] === last_3[2] && last_3[0] !== last_3[1]) {
        return [last_result === "T√†i" ? "X·ªâu" : "T√†i", 83, `C·∫ßu sandwich ${last_3.join('-')}. B·∫ª c·∫ßu!`];
    }
    // C·∫ßu l·∫∑p l·∫°i
    if (last_3[0] === last_3[2] || last_3[1] === last_3[2]) {
        return [last_result === "T√†i" ? "X·ªâu" : "T√†i", 77, `C·∫ßu l·∫∑p d·∫°ng ${last_3.join('-')}. B·∫ª c·∫ßu.`];
    }
    
    return [last_result === "T√†i" ? "X·ªâu" : "T√†i", 71, "Kh√¥ng c√≥ c·∫ßu ƒë·∫∑c bi·ªát n√†o, b·∫ª c·∫ßu m·∫∑c ƒë·ªãnh."];
}

// ===== THU·∫¨T TO√ÅN 4: Ph√¢n t√≠ch ƒë∆°n gi·∫£n =====
function du_doan_v4(kq_list, tong_list) {
    if (kq_list.length < 3) return ["Ch·ªù", 50];
    const tin_cay = 50;
    if (kq_list.slice(-3).join(',') === 'T√†i,T√†i,T√†i') return ["X·ªâu", Math.min(tin_cay + 20, 95)];
    if (kq_list.slice(-3).join(',') === 'X·ªâu,X·ªâu,X·ªâu') return ["T√†i", Math.min(tin_cay + 20, 95)];
    if (kq_list.slice(-2).join(',') === 'T√†i,X·ªâu') return ["T√†i", Math.min(tin_cay + 10, 95)];
    if (tong_list.at(-1) >= 15) return ["X·ªâu", Math.min(tin_cay + 10, 95)];
    if (tong_list.at(-1) <= 9) return ["T√†i", Math.min(tin_cay + 10, 95)];
    return [kq_list.at(-1), tin_cay];
}

// ===== THU·∫¨T TO√ÅN 5: D·ª± ƒëo√°n theo hash =====
function du_doan_phan_tram(input_str) {
    const algo1 = parseInt(crypto.createHash('sha256').update(input_str).digest('hex'), 16) % 100;
    const algo2 = input_str.split('').reduce((sum, char) => sum + char.charCodeAt(0), 0) % 100;
    const algo3 = parseInt(crypto.createHash('sha1').update(input_str).digest('hex').slice(-2), 16) % 100;
    return parseFloat(((algo1 + algo2 + algo3) / 3).toFixed(2));
}

// ===== THU·∫¨T TO√ÅN 6: D·ª± ƒëo√°n theo x√∫c x·∫Øc =====
function du_doan_theo_xi_ngau(dice_list) {
    if (!dice_list.length) return "ƒê·ª£i d·ªØ li·ªáu";
    const [d1, d2, d3] = dice_list.at(-1);
    const total = d1 + d2 + d3;
    const result_list = [d1, d2, d3].map(d => {
        let tmp = d + total;
        if (tmp === 4 || tmp === 5) tmp -= 4;
        else if (tmp >= 6) tmp -= 6;
        return tmp % 2 === 0 ? "T√†i" : "X·ªâu";
    });
    const tai_count = result_list.filter(r => r === "T√†i").length;
    return tai_count >= 2 ? "T√†i" : "X·ªâu";
}


// ===== H√ÄM T·ªîNG H·ª¢P D·ª∞ ƒêO√ÅN =====
function du_doan_tong_hop(totals_list, kq_list, dice_list, ma_phien) {
    if (totals_list.length < 1) {
        return { prediction: "Ch·ªù", tincay: "0%", chi_tiet: {}, ket_luan: "Ch∆∞a c√≥ d·ªØ li·ªáu." };
    }

    const chi_tiet = {};
    
    const [du1, ly1] = du_doan_v1(totals_list);
    chi_tiet["v1"] = { du_doan: du1, ly_do: ly1 };

    const [du2, tin2, ly2] = du_doan_v2(totals_list);
    chi_tiet["v2"] = { du_doan: du2, tin_cay: `${tin2}%`, ly_do: ly2 };

    const [du4, tin4] = du_doan_v4(kq_list, totals_list);
    chi_tiet["v4"] = { du_doan: du4, tin_cay: `${tin4}%` };

    const tin5 = du_doan_phan_tram(ma_phien);
    chi_tiet["v5"] = { du_doan: tin5 >= 50 ? "T√†i" : "X·ªâu", tin_cay: `${tin5}%` };

    const du6 = du_doan_theo_xi_ngau(dice_list);
    chi_tiet["v6"] = { du_doan: du6 };
    
    // T·ªïng h·ª£p k·∫øt qu·∫£ t·ª´ c√°c thu·∫≠t to√°n ƒë√£ ch·ªçn
    const all_du_doan = Object.values(chi_tiet).map(v => v.du_doan).filter(d => d === "T√†i" || d === "X·ªâu");
    const tai_count = all_du_doan.filter(d => d === "T√†i").length;
    const xiu_count = all_du_doan.filter(d => d === "X·ªâu").length;
    const total_algos = all_du_doan.length;

    let ket_luan = "";
    let final_prediction = "Ch·ªù";
    let tincay = "0%";

    if (total_algos > 0) {
        if (tai_count > xiu_count) {
            final_prediction = "T√†i";
            ket_luan = `üéØ N√™n ƒë√°nh: T√ÄI (${tai_count}/${total_algos} thu·∫≠t to√°n)`;
            tincay = `${(tai_count / total_algos * 100).toFixed(1)}%`;
        } else if (xiu_count > tai_count) {
            final_prediction = "X·ªâu";
            ket_luan = `üéØ N√™n ƒë√°nh: X·ªàU (${xiu_count}/${total_algos} thu·∫≠t to√°n)`;
            tincay = `${(xiu_count / total_algos * 100).toFixed(1)}%`;
        } else {
            ket_luan = "‚öñÔ∏è T·ªâ l·ªá c√¢n b·∫±ng, c√¢n nh·∫Øc k·ªπ!";
            final_prediction = kq_list.at(-1) === "T√†i" ? "X·ªâu" : "T√†i"; // N·∫øu c√¢n b·∫±ng th√¨ b·∫ª c·∫ßu
            tincay = "50.0%";
        }
    }

    return {
        prediction: final_prediction,
        tincay: tincay,
        chi_tiet: chi_tiet,
        ket_luan: ket_luan,
    };
}


// =================================================================
// ===== H·ªÜ TH·ªêNG SERVER V√Ä WEBSOCKET (Kh√¥ng thay ƒë·ªïi nhi·ªÅu) =====
// =================================================================

function updatePatternHistory(result) {
    if (patternHistory.length >= 20) {
        patternHistory = patternHistory.slice(1);
    }
    patternHistory += result;
    currentData.cau = patternHistory;
}

const WS_URL = "wss://websocket.atpman.net/websocket";
const HEADERS = {
    "Host": "websocket.atpman.net",
    "Origin": "https://play.789club.sx",
    "User-Agent": "Mozilla/5.0",
};
let lastEventId = 19;
const LOGIN_MESSAGE = [1,"MiniGame","thatoidimoo11233","112233",{info:'{"ipAddress":"2405:4802:18c2:5990:3f0:c150:861d:5427","userId":"6ba5b041-a68d-4468-95d3-0bb2d8674512","username":"S8_thatoidimoo11233","timestamp":1752497763866,"refreshToken":"c6c49a4ff8ca49ac87fcaf2543a96221.6f17553681b74176a4ebeb77f475f443"}',signature:"5F953D843B438DD810A98D903AD3623CE98AED1745C3925EEAFD2A5BEB4D86A24ED0B97129E6AAB5DA1C3F73C2A236AE06D08EDDD937991260DFEA543E8F1C8818A651BDF4204E97A53F0461B306A95A6D7D56F435326270E9E4CB8084BB93969BFD4DB3CA8E519D079324E47110BCC23AB2139508D9E762407B76DE542D6E68"}];
const SUBSCRIBE_TX_RESULT = [6, "MiniGame", "taixiuUnbalancedPlugin", { cmd: 2000 }];
const SUBSCRIBE_LOBBY = [6, "MiniGame", "lobbyPlugin", { cmd: 10001 }];

function connectWebSocket() {
    const ws = new WebSocket(WS_URL, { headers: HEADERS });

    ws.on('open', () => {
        console.log("‚úÖ ƒê√£ k·∫øt n·ªëi WebSocket");
        ws.send(JSON.stringify(LOGIN_MESSAGE));
        setTimeout(() => {
            ws.send(JSON.stringify(SUBSCRIBE_TX_RESULT));
            ws.send(JSON.stringify(SUBSCRIBE_LOBBY));
        }, 1000);
        setInterval(() => ws.send("2"), 10000);
    });

    ws.on('message', (msg) => {
        try {
            const data = JSON.parse(msg);
            if (Array.isArray(data) && data[1]?.cmd === 2006) {
                const { sid, d1, d2, d3 } = data[1];
                const total = d1 + d2 + d3;
                const ketqua = getTaiXiu(total);

                // C·∫≠p nh·∫≠t l·ªãch s·ª≠ cho c√°c thu·∫≠t to√°n
                totalsHistory.push(total);
                kqHistory.push(ketqua);
                diceHistory.push([d1, d2, d3]);

                // Gi·ªõi h·∫°n l·ªãch s·ª≠ ƒë·ªÉ kh√¥ng tr√†n b·ªô nh·ªõ
                if (totalsHistory.length > 50) {
                    totalsHistory.shift();
                    kqHistory.shift();
                    diceHistory.shift();
                }

                // G·ªçi h√†m t·ªïng h·ª£p d·ª± ƒëo√°n
                const ma_phien = `PH_${sid}`;
                const predictionResult = du_doan_tong_hop(totalsHistory, kqHistory, diceHistory, ma_phien);

                // C·∫≠p nh·∫≠t d·ªØ li·ªáu ƒë·ªÉ tr·∫£ v·ªÅ API
                currentData.phien_truoc = currentData.phien_hien_tai;
                currentData.phien_hien_tai = sid;
                currentData.ket_qua = ketqua;
                currentData.du_doan = predictionResult.prediction;
                currentData.do_tin_cay = predictionResult.tincay;
                currentData.chi_tiet_du_doan = predictionResult.ket_luan; // G·ª≠i v·ªÅ l√Ω do t√≥m t·∫Øt
                currentData.ngay = new Date().toLocaleString("vi-VN", { timeZone: "Asia/Ho_Chi_Minh" });
                
                updatePatternHistory(ketqua === "T√†i" ? 'T' : 'X');

                console.log(`\nüé≤ PHI√äN ${sid}: ${ketqua} (${total})`);
                console.log(`üéØ D·ª∞ ƒêO√ÅN: ${predictionResult.prediction} (ƒê·ªô tin c·∫≠y: ${predictionResult.tincay})`);
                console.log(`üìú K·∫æT LU·∫¨N: ${predictionResult.ket_luan}`);
            }
        } catch (err) {
            // L·ªói kh√¥ng quan tr·ªçng, b·ªè qua
        }
    });

    ws.on('close', () => {
        console.log("üîå WebSocket b·ªã ƒë√≥ng. K·∫øt n·ªëi l·∫°i sau 5s‚Ä¶");
        setTimeout(connectWebSocket, 5000);
    });

    ws.on('error', (err) => {
        console.error("‚ùå L·ªói WebSocket:", err.message);
    });
}

const server = http.createServer((req, res) => {
    res.setHeader("Access-Control-Allow-Origin", "*"); // Cho ph√©p m·ªçi ngu·ªìn
    res.setHeader("Access-Control-Allow-Methods", "GET, OPTIONS");
    if (req.method === "OPTIONS") {
        res.writeHead(204);
        res.end();
        return;
    }
    if (req.url === "/taixiu") {
        res.writeHead(200, { "Content-Type": "application/json" });
        res.end(JSON.stringify(currentData));
    } else {
        res.writeHead(404);
        res.end("Not Found");
    }
});

server.listen(PORT, () => {
    console.log(`üåê Server ƒëang ch·∫°y t·∫°i http://localhost:${PORT}`);
    connectWebSocket();
});
